{% extends 'exercises/base.html' %}
{% load static %}

{% block title %}{{ exercise.name }} Session - FitSync{% endblock %}

{% block extra_css %}
<style>
    .session-container {
        max-width: 1200px;
        margin: 2rem auto;
        padding: 0 1rem;
    }
    
    .session-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
    }
    
    .session-title {
        margin: 0;
        color: #007bff;
    }
    
    .session-stats {
        display: flex;
        gap: 1rem;
    }
    
    .stat-badge {
        background: #f5f5f5;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-weight: 500;
    }
    
    .session-content {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 2rem;
    }
    
    .camera-container {
        background: #000;
        border-radius: 8px;
        overflow: hidden;
        position: relative;
        aspect-ratio: 16/9;
    }
    
    #webcam {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
    }
    
    .pose-landmarks {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
    }
    
    .exercise-sidebar {
        background: white;
        border-radius: 8px;
        padding: 1.5rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .exercise-info {
        margin-bottom: 2rem;
    }
    
    .exercise-info h3 {
        margin: 0 0 1rem;
        color: #333;
    }
    
    .exercise-description {
        color: #666;
        line-height: 1.6;
        margin-bottom: 1rem;
    }
    
    .form-check {
        margin-bottom: 0.5rem;
    }
    
    .form-check-label {
        color: #666;
    }
    
    .progress-section {
        margin-top: 2rem;
    }
    
    .progress-section h3 {
        margin: 0 0 1rem;
        color: #333;
    }
    
    .progress-bar {
        width: 100%;
        height: 8px;
        background: #e9ecef;
        border-radius: 4px;
        overflow: hidden;
        margin-bottom: 0.5rem;
    }
    
    .progress-fill {
        height: 100%;
        background: #28a745;
        width: 0%;
        transition: width 0.3s ease;
    }
    
    .progress-text {
        text-align: center;
        color: #666;
        font-size: 0.875rem;
    }
    
    .controls {
        margin-top: 2rem;
        display: flex;
        gap: 1rem;
    }
    
    .btn {
        flex: 1;
        padding: 0.75rem;
        border: none;
        border-radius: 4px;
        font-weight: 500;
        cursor: pointer;
        transition: background-color 0.3s;
    }
    
    .btn-primary {
        background: #007bff;
        color: white;
    }
    
    .btn-primary:hover {
        background: #0056b3;
    }
    
    .btn-secondary {
        background: #6c757d;
        color: white;
    }
    
    .btn-secondary:hover {
        background: #545b62;
    }
    
    .feedback {
        margin-top: 1rem;
        padding: 1rem;
        border-radius: 4px;
        text-align: center;
        display: none;
    }
    
    .feedback.success {
        background: #d4edda;
        color: #155724;
        display: block;
    }
    
    .feedback.error {
        background: #f8d7da;
        color: #721c24;
        display: block;
    }
    
    .guide-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        display: none;
    }
    
    .guide-line {
        position: absolute;
        background: rgba(0, 255, 0, 0.5);
        pointer-events: none;
    }
    
    .guide-angle {
        position: absolute;
        color: rgba(0, 255, 0, 0.8);
        font-size: 16px;
        font-weight: bold;
        pointer-events: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="session-container">
    <div class="session-header">
        <h1 class="session-title">{{ exercise.name }}</h1>
        <div class="session-stats">
            <span class="stat-badge">Level {{ user.level }}</span>
            <span class="stat-badge">{{ user.total_exp }} EXP</span>
        </div>
    </div>
    
    <div class="session-content">
        <div class="camera-container">
            <video id="webcam" autoplay playsinline></video>
            <canvas class="overlay" id="overlay"></canvas>
            <canvas class="pose-landmarks" id="pose-landmarks"></canvas>
            <div class="guide-overlay" id="guide-overlay"></div>
        </div>
        
        <div class="exercise-sidebar">
            <div class="exercise-info">
                <h3>Exercise Details</h3>
                <p class="exercise-description">{{ exercise.description }}</p>
                <div class="form-check">
                    <input type="checkbox" class="form-check-input" id="show-guide">
                    <label class="form-check-label" for="show-guide">Show form guide</label>
                </div>
            </div>
            
            <div class="progress-section">
                <h3>Progress</h3>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                <div class="progress-text">
                    <span id="rep-count">0</span> / <span id="target-reps">10</span> reps
                </div>
                <div class="exp-info">
                    <span>EXP per rep: <span id="exp-per-rep">{{ exercise.exp_per_rep }}</span></span>
                    <span>Total EXP: <span id="total-exp">{{ user.exp }}</span></span>
                    <span>Level: <span id="user-level">{{ user.level }}</span></span>
                </div>
            </div>
            
            <div class="controls">
                <button class="btn btn-primary" id="start-btn">Start Exercise</button>
                <button class="btn btn-secondary" id="pause-btn" disabled>Pause</button>
            </div>
            
            <div class="feedback" id="feedback"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
<script>
    let camera;
    let pose;
    let isTracking = false;
    let repCount = 0;
    let targetReps = 10;
    let isPaused = false;
    let lastCountTime = 0;
    let inProperPosition = false;
    let showGuide = false;
    
    // Initialize MediaPipe Pose
    async function initPose() {
        pose = new Pose({
            locateFile: (file) => {
                return `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`;
            }
        });
        
        pose.setOptions({
            modelComplexity: 1,
            smoothLandmarks: true,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });
        
        pose.onResults(onPoseResults);
    }
    
    // Start webcam
    async function startWebcam() {
        const videoElement = document.getElementById('webcam');
        const stream = await navigator.mediaDevices.getUserMedia({
            video: { width: 1280, height: 720 }
        });
        videoElement.srcObject = stream;
        
        camera = new Camera(videoElement, {
            onFrame: async () => {
                await pose.send({image: videoElement});
            },
            width: 1280,
            height: 720
        });
        
        await initPose();
        camera.start();
        isTracking = true;
    }
    
    // Handle pose detection results
    function onPoseResults(results) {
        if (!isPaused) {
            const canvas = document.getElementById('overlay');
            const ctx = canvas.getContext('2d');
            
            // Draw video
            ctx.save();
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);
            
            if (results.poseLandmarks) {
                // Draw pose landmarks
                for (const landmark of results.poseLandmarks) {
                    ctx.fillStyle = 'red';
                    ctx.beginPath();
                    ctx.arc(landmark.x * canvas.width, landmark.y * canvas.height, 5, 0, 2 * Math.PI);
                    ctx.fill();
                }
                
                if (showGuide) {
                    drawFormGuide(results.poseLandmarks, canvas.width, canvas.height);
                }
                
                checkExerciseForm(results.poseLandmarks);
            }
            ctx.restore();
        }
    }
    
    // Check exercise form
    function checkExerciseForm(landmarks) {
        const now = Date.now();
        if (now - lastCountTime < 1000) return; // 1-second debounce
        
        let isInProperPosition = false;
        let wasInDefaultPosition = !inProperPosition;
        
        // Exercise-specific form checking
        switch ('{{ exercise.name|lower }}') {
            case 'pushup':
                const leftElbowAngle = calculateAngle(
                    landmarks[11], // left shoulder
                    landmarks[13], // left elbow
                    landmarks[15]  // left wrist
                );
                const rightElbowAngle = calculateAngle(
                    landmarks[12], // right shoulder
                    landmarks[14], // right elbow
                    landmarks[16]  // right wrist
                );
                isInProperPosition = leftElbowAngle < 90 && rightElbowAngle < 90;
                break;
                
            case 'squat':
                const leftKneeAngle = calculateAngle(
                    landmarks[23], // left hip
                    landmarks[25], // left knee
                    landmarks[27]  // left ankle
                );
                const rightKneeAngle = calculateAngle(
                    landmarks[24], // right hip
                    landmarks[26], // right knee
                    landmarks[28]  // right ankle
                );
                isInProperPosition = leftKneeAngle < 90 && rightKneeAngle < 90;
                break;
                
            case 'plank':
                const bodyAngle = calculateAngle(
                    landmarks[11], // shoulder
                    landmarks[23], // hip
                    landmarks[27]  // ankle
                );
                isInProperPosition = Math.abs(180 - bodyAngle) < 20;
                break;
                
            case 'arm raises':
                const hipLevel = (landmarks[23].y + landmarks[24].y) / 2;
                const earLevel = Math.min(landmarks[7].y, landmarks[8].y);
                const leftWristAboveHead = landmarks[15].y < earLevel;
                const rightWristAboveHead = landmarks[16].y < earLevel;
                const wristsBelowHips = landmarks[15].y > hipLevel && landmarks[16].y > hipLevel;
                
                if (wristsBelowHips) {
                    wasInDefaultPosition = true;
                }
                isInProperPosition = leftWristAboveHead && rightWristAboveHead;
                break;
                
            case 'jumping jack':
                const leftArmAngle = calculateAngle(
                    landmarks[11], // left shoulder
                    landmarks[13], // left elbow
                    landmarks[15]  // left wrist
                );
                const rightArmAngle = calculateAngle(
                    landmarks[12], // right shoulder
                    landmarks[14], // right elbow
                    landmarks[16]  // right wrist
                );
                const legSpread = Math.abs(landmarks[23].x - landmarks[24].x) * window.innerWidth;
                isInProperPosition = leftArmAngle > 160 && rightArmAngle > 160 && legSpread > 100;
                break;
        }
        
        if (isInProperPosition && wasInDefaultPosition) {
            repCount++;
            document.getElementById('rep-count').textContent = repCount;
            updateProgress();
            lastCountTime = now;
        }
        inProperPosition = isInProperPosition;
    }
    
    function calculateAngle(a, b, c) {
        const radians = Math.atan2(c.y - b.y, c.x - b.x) - Math.atan2(a.y - b.y, a.x - b.x);
        let angle = Math.abs(radians * 180.0 / Math.PI);
        if (angle > 180.0) angle = 360 - angle;
        return angle;
    }
    
    // Update progress
    function updateProgress() {
        const progressFill = document.getElementById('progress-fill');
        const repCount = document.getElementById('rep-count');
        const targetReps = document.getElementById('target-reps');
        const progress = (repCount.textContent / targetReps.textContent) * 100;
        progressFill.style.width = `${progress}%`;
        
        if (repCount.textContent >= targetReps.textContent) {
            completeExercise();
        }
    }
    
    // Complete exercise
    function completeExercise() {
        const repsCompleted = parseInt(document.getElementById('rep-count').textContent);
        
        fetch(`/exercises/{{ exercise.id }}/complete/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                reps_completed: repsCompleted
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update EXP and level display
                document.getElementById('total-exp').textContent = data.total_exp;
                document.getElementById('user-level').textContent = data.level;
                
                // Show success message
                const feedback = document.getElementById('feedback');
                feedback.innerHTML = `
                    <div class="alert alert-success">
                        Exercise completed! Earned ${data.exp_earned} EXP.
                    </div>
                `;
                
                // Disable controls
                document.getElementById('start-btn').disabled = true;
                document.getElementById('pause-btn').disabled = true;
                
                // Stop the camera
                if (camera) {
                    camera.stop();
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
            const feedback = document.getElementById('feedback');
            feedback.innerHTML = `
                <div class="alert alert-danger">
                    Error completing exercise. Please try again.
                </div>
            `;
        });
    }
    
    // Event listeners
    document.getElementById('start-btn').addEventListener('click', () => {
        startWebcam();
        document.getElementById('start-btn').disabled = true;
        document.getElementById('pause-btn').disabled = false;
    });
    
    document.getElementById('pause-btn').addEventListener('click', () => {
        isPaused = !isPaused;
        document.getElementById('pause-btn').textContent = isPaused ? 'Resume' : 'Pause';
    });
    
    // Add event listener for show guide checkbox
    document.getElementById('show-guide').addEventListener('change', (e) => {
        showGuide = e.target.checked;
        document.getElementById('guide-overlay').style.display = showGuide ? 'block' : 'none';
    });
    
    // Utility function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    function drawFormGuide(landmarks, width, height) {
        const guideOverlay = document.getElementById('guide-overlay');
        guideOverlay.innerHTML = ''; // Clear previous guides
        
        switch ('{{ exercise.name|lower }}') {
            case 'pushup':
                // Draw guide lines for push-up
                const leftElbowAngle = calculateAngle(
                    landmarks[11], landmarks[13], landmarks[15]
                );
                const rightElbowAngle = calculateAngle(
                    landmarks[12], landmarks[14], landmarks[16]
                );
                
                // Draw elbow angle guides
                drawAngleGuide(landmarks[11], landmarks[13], landmarks[15], width, height, leftElbowAngle);
                drawAngleGuide(landmarks[12], landmarks[14], landmarks[16], width, height, rightElbowAngle);
                
                // Draw target angle line
                drawTargetAngleLine(landmarks[13], landmarks[15], width, height, 90);
                drawTargetAngleLine(landmarks[14], landmarks[16], width, height, 90);
                break;
                
            case 'squat':
                // Draw guide lines for squat
                const leftKneeAngle = calculateAngle(
                    landmarks[23], landmarks[25], landmarks[27]
                );
                const rightKneeAngle = calculateAngle(
                    landmarks[24], landmarks[26], landmarks[28]
                );
                
                // Draw knee angle guides
                drawAngleGuide(landmarks[23], landmarks[25], landmarks[27], width, height, leftKneeAngle);
                drawAngleGuide(landmarks[24], landmarks[26], landmarks[28], width, height, rightKneeAngle);
                
                // Draw target angle line
                drawTargetAngleLine(landmarks[25], landmarks[27], width, height, 90);
                drawTargetAngleLine(landmarks[26], landmarks[28], width, height, 90);
                break;
                
            case 'plank':
                // Draw guide line for plank
                const bodyAngle = calculateAngle(
                    landmarks[11], landmarks[23], landmarks[27]
                );
                
                // Draw body alignment guide
                drawAngleGuide(landmarks[11], landmarks[23], landmarks[27], width, height, bodyAngle);
                
                // Draw target line
                drawTargetAngleLine(landmarks[23], landmarks[27], width, height, 180);
                break;
                
            case 'arm raises':
                // Draw guide lines for arm raises
                const hipLevel = (landmarks[23].y + landmarks[24].y) / 2;
                const earLevel = Math.min(landmarks[7].y, landmarks[8].y);
                
                // Draw target lines for arms
                drawTargetAngleLine(landmarks[13], landmarks[15], width, height, 180);
                drawTargetAngleLine(landmarks[14], landmarks[16], width, height, 180);
                
                // Draw hip level indicator
                const hipLine = document.createElement('div');
                hipLine.className = 'guide-line';
                hipLine.style.width = '100%';
                hipLine.style.height = '2px';
                hipLine.style.left = '0';
                hipLine.style.top = `${hipLevel * height}px`;
                hipLine.style.background = 'rgba(255, 255, 0, 0.5)';
                guideOverlay.appendChild(hipLine);
                
                // Draw ear level indicator
                const earLine = document.createElement('div');
                earLine.className = 'guide-line';
                earLine.style.width = '100%';
                earLine.style.height = '2px';
                earLine.style.left = '0';
                earLine.style.top = `${earLevel * height}px`;
                earLine.style.background = 'rgba(255, 255, 0, 0.5)';
                guideOverlay.appendChild(earLine);
                break;
                
            case 'jumping jack':
                // Draw guide lines for jumping jack
                const leftArmAngle = calculateAngle(
                    landmarks[11], landmarks[13], landmarks[15]
                );
                const rightArmAngle = calculateAngle(
                    landmarks[12], landmarks[14], landmarks[16]
                );
                
                // Draw arm angle guides
                drawAngleGuide(landmarks[11], landmarks[13], landmarks[15], width, height, leftArmAngle);
                drawAngleGuide(landmarks[12], landmarks[14], landmarks[16], width, height, rightArmAngle);
                
                // Draw target angle lines
                drawTargetAngleLine(landmarks[13], landmarks[15], width, height, 180);
                drawTargetAngleLine(landmarks[14], landmarks[16], width, height, 180);
                
                // Draw leg spread indicator
                const legSpread = Math.abs(landmarks[23].x - landmarks[24].x) * width;
                const spreadText = document.createElement('div');
                spreadText.className = 'guide-angle';
                spreadText.textContent = `Spread: ${Math.round(legSpread)}px`;
                spreadText.style.left = `${(landmarks[23].x + landmarks[24].x) * width / 2}px`;
                spreadText.style.top = `${(landmarks[23].y + landmarks[24].y) * height / 2}px`;
                guideOverlay.appendChild(spreadText);
                break;
        }
    }
    
    function drawAngleGuide(a, b, c, width, height, angle) {
        const guideOverlay = document.getElementById('guide-overlay');
        
        // Draw lines
        const line1 = document.createElement('div');
        line1.className = 'guide-line';
        line1.style.width = '2px';
        line1.style.height = `${Math.sqrt(Math.pow((b.x - a.x) * width, 2) + Math.pow((b.y - a.y) * height, 2))}px`;
        line1.style.left = `${a.x * width}px`;
        line1.style.top = `${a.y * height}px`;
        line1.style.transform = `rotate(${Math.atan2((b.y - a.y) * height, (b.x - a.x) * width) * 180 / Math.PI}deg)`;
        
        const line2 = document.createElement('div');
        line2.className = 'guide-line';
        line2.style.width = '2px';
        line2.style.height = `${Math.sqrt(Math.pow((c.x - b.x) * width, 2) + Math.pow((c.y - b.y) * height, 2))}px`;
        line2.style.left = `${b.x * width}px`;
        line2.style.top = `${b.y * height}px`;
        line2.style.transform = `rotate(${Math.atan2((c.y - b.y) * height, (c.x - b.x) * width) * 180 / Math.PI}deg)`;
        
        // Draw angle text
        const angleText = document.createElement('div');
        angleText.className = 'guide-angle';
        angleText.textContent = `${Math.round(angle)}Â°`;
        angleText.style.left = `${b.x * width}px`;
        angleText.style.top = `${b.y * height}px`;
        
        guideOverlay.appendChild(line1);
        guideOverlay.appendChild(line2);
        guideOverlay.appendChild(angleText);
    }
    
    function drawTargetAngleLine(b, c, width, height, targetAngle) {
        const guideOverlay = document.getElementById('guide-overlay');
        
        // Calculate target position
        const currentAngle = Math.atan2((c.y - b.y) * height, (c.x - b.x) * width);
        const targetX = b.x * width + Math.cos(currentAngle + (targetAngle * Math.PI / 180)) * 100;
        const targetY = b.y * height + Math.sin(currentAngle + (targetAngle * Math.PI / 180)) * 100;
        
        // Draw target line
        const line = document.createElement('div');
        line.className = 'guide-line';
        line.style.width = '2px';
        line.style.height = '100px';
        line.style.left = `${b.x * width}px`;
        line.style.top = `${b.y * height}px`;
        line.style.transform = `rotate(${currentAngle + (targetAngle * Math.PI / 180)} * 180 / Math.PI}deg)`;
        line.style.background = 'rgba(255, 255, 0, 0.5)';
        
        guideOverlay.appendChild(line);
    }
</script>
{% endblock %} 